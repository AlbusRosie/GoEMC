<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Product Options & Cart API</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .option-group { margin: 20px 0; padding: 15px; border: 1px solid #ddd; }
        .option-title { font-weight: bold; margin-bottom: 10px; }
        .option-value-btn { 
            display: inline-block; 
            padding: 8px 12px; 
            border: 1px solid #ddd; 
            margin: 5px; 
            cursor: pointer; 
            background: white;
        }
        .option-value-btn:hover { background: #f0f0f0; }
        .option-value-btn.selected { background: #007bff; color: white; }
        .option-value-btn.disabled { opacity: 0.5; cursor: not-allowed; }
        .quantity-group { display: flex; align-items: center; margin: 10px 0; }
        .quantity-btn { width: 30px; height: 30px; border: 1px solid #ddd; background: white; cursor: pointer; }
        .quantity-input { width: 50px; text-align: center; border: 1px solid #ddd; height: 28px; }
        .btn { padding: 10px 20px; margin: 5px; cursor: pointer; border: none; }
        .btn-primary { background: #007bff; color: white; }
        .btn-success { background: #28a745; color: white; }
        .debug-panel { background: #f8f9fa; padding: 15px; margin: 20px 0; border: 1px solid #ddd; }
        .log { background: #000; color: #0f0; padding: 10px; font-family: monospace; height: 200px; overflow-y: auto; }
    </style>
</head>
<body>
    <h1>Test Product Options & Cart API</h1>
    
    <div class="debug-panel">
        <h3>Debug Panel</h3>
        <button onclick="debugCurrentState()">Debug Current State</button>
        <button onclick="clearLog()">Clear Log</button>
        <div id="log" class="log"></div>
    </div>
    
    <div class="product-container">
        <h2>Product: Test Gỗ Sồi</h2>
        
        <!-- Size Options -->
        <div class="option-group">
            <div class="option-title">Kích thước *</div>
            <div class="option-values">
                <label class="option-value-btn" onclick="selectOption(this, 'size', '4x8 feet', 1)">
                    <input type="radio" name="option_size" value="4x8 feet" class="d-none" required data-value-id="1">
                    4x8 feet
                </label>
                <label class="option-value-btn" onclick="selectOption(this, 'size', '4x6 feet', 2)">
                    <input type="radio" name="option_size" value="4x6 feet" class="d-none" required data-value-id="2">
                    4x6 feet
                </label>
                <label class="option-value-btn disabled" onclick="selectOption(this, 'size', '6x8 feet', 3)">
                    <input type="radio" name="option_size" value="6x8 feet" class="d-none" required data-value-id="3" disabled>
                    6x8 feet (Hết hàng)
                </label>
            </div>
        </div>
        
        <!-- Color Options -->
        <div class="option-group">
            <div class="option-title">Màu sắc *</div>
            <div class="option-values">
                <label class="option-value-btn" onclick="selectOption(this, 'color', 'Nâu tự nhiên', 4)">
                    <input type="radio" name="option_color" value="Nâu tự nhiên" class="d-none" required data-value-id="4">
                    Nâu tự nhiên
                </label>
                <label class="option-value-btn" onclick="selectOption(this, 'color', 'Nâu đậm', 5)">
                    <input type="radio" name="option_color" value="Nâu đậm" class="d-none" required data-value-id="5">
                    Nâu đậm
                </label>
                <label class="option-value-btn" onclick="selectOption(this, 'color', 'Trắng', 6)">
                    <input type="radio" name="option_color" value="Trắng" class="d-none" required data-value-id="6">
                    Trắng
                </label>
            </div>
        </div>
        
        <!-- Quantity -->
        <div class="quantity-group">
            <span>Số lượng:</span>
            <button class="quantity-btn" onclick="changeQuantity(-1)">-</button>
            <input type="text" id="quantity" class="quantity-input" value="1" readonly>
            <button class="quantity-btn" onclick="changeQuantity(1)">+</button>
        </div>
        
        <!-- Action Buttons -->
        <div class="actions">
            <button class="btn btn-primary" onclick="addToCart()">THÊM VÀO GIỎ</button>
            <button class="btn btn-success" onclick="buyNow()">MUA NGAY</button>
        </div>
    </div>
    
    <div class="debug-panel">
        <h3>API Test Results</h3>
        <div id="api-results"></div>
    </div>

    <script>
        // Mock product data
        const productOptions = [
            {
                id: 1,
                name: 'Kích thước',
                is_required: 1,
                values: [
                    { id: 1, value: '4x8 feet', stock_quantity: 10 },
                    { id: 2, value: '4x6 feet', stock_quantity: 5 },
                    { id: 3, value: '6x8 feet', stock_quantity: 0 }
                ]
            },
            {
                id: 2,
                name: 'Màu sắc',
                is_required: 1,
                values: [
                    { id: 4, value: 'Nâu tự nhiên', stock_quantity: 8 },
                    { id: 5, value: 'Nâu đậm', stock_quantity: 6 },
                    { id: 6, value: 'Trắng', stock_quantity: 4 }
                ]
            }
        ];
        
        // Logging function
        function log(message) {
            const logElement = document.getElementById('log');
            const timestamp = new Date().toLocaleTimeString();
            logElement.innerHTML += `[${timestamp}] ${message}\n`;
            logElement.scrollTop = logElement.scrollHeight;
            console.log(message);
        }
        
        function clearLog() {
            document.getElementById('log').innerHTML = '';
        }
        
        // Quantity controls
        function changeQuantity(delta) {
            const quantityInput = document.getElementById('quantity');
            let currentQuantity = parseInt(quantityInput.value);
            currentQuantity = Math.max(1, currentQuantity + delta);
            quantityInput.value = currentQuantity;
            log(`Quantity changed to: ${currentQuantity}`);
        }
        
        // Option selection
        function selectOption(element, optionType, optionValue, valueId) {
            log(`Selecting option: ${optionType} = ${optionValue} (ID: ${valueId})`);
            
            // Check if disabled
            const radioInput = element.querySelector('input[type="radio"]');
            if (radioInput && radioInput.disabled) {
                log('Option is disabled, cannot select');
                return;
            }
            
            // Remove selected class from siblings
            const optionGroup = element.closest('.option-group');
            optionGroup.querySelectorAll('.option-value-btn').forEach(btn => {
                btn.classList.remove('selected');
            });
            
            // Add selected class
            element.classList.add('selected');
            
            // Check radio
            if (radioInput) {
                radioInput.checked = true;
            }
            
            log(`Option selected: ${optionType} = ${optionValue}`);
        }
        
        // Debug current state
        function debugCurrentState() {
            log('=== DEBUG CURRENT STATE ===');
            log(`Product options available: ${productOptions.length}`);
            log(`Option groups found: ${document.querySelectorAll('.option-group').length}`);
            log(`Required inputs found: ${document.querySelectorAll('input[required]').length}`);
            log(`Checked inputs found: ${document.querySelectorAll('input[type="radio"]:checked').length}`);
            
            const selectedOptions = {};
            document.querySelectorAll('.option-group').forEach(group => {
                const checkedInput = group.querySelector('input[type="radio"]:checked');
                if (checkedInput) {
                    const optionTitle = group.querySelector('.option-title');
                    const optionName = optionTitle ? optionTitle.textContent.trim().replace(/\s*\*$/, '') : 'Unknown';
                    selectedOptions[optionName] = checkedInput.value;
                }
            });
            
            log(`Selected options: ${JSON.stringify(selectedOptions)}`);
            return selectedOptions;
        }
        
        // Add to cart function
        function addToCart() {
            log('=== ADD TO CART STARTED ===');
            
            const quantity = document.getElementById('quantity').value;
            const productId = 1; // Test product ID
            
            log(`Product ID: ${productId}`);
            log(`Quantity: ${quantity}`);
            
            // Validate required options
            const allOptionGroups = document.querySelectorAll('.option-group');
            let isValid = true;
            let missingOptions = [];
            
            log(`Found option groups: ${allOptionGroups.length}`);
            
            allOptionGroups.forEach(group => {
                const requiredInput = group.querySelector('input[required]');
                if (requiredInput) {
                    const optionTitle = group.querySelector('.option-title');
                    const optionName = optionTitle ? optionTitle.textContent.trim().replace(/\s*\*$/, '') : 'Unknown Option';
                    const checkedInput = group.querySelector('input[type="radio"]:checked');
                    
                    log(`Checking required option: ${optionName}, Checked: ${!!checkedInput}`);
                    
                    if (!checkedInput) {
                        missingOptions.push(optionName);
                        isValid = false;
                    }
                }
            });
            
            if (!isValid) {
                log(`Validation failed. Missing options: ${missingOptions.join(', ')}`);
                alert('Vui lòng chọn: ' + missingOptions.join(', '));
                return;
            }
            
            // Get selected options
            const selectedOptions = {};
            allOptionGroups.forEach(group => {
                const checkedInput = group.querySelector('input[type="radio"]:checked');
                if (checkedInput) {
                    const optionTitle = group.querySelector('.option-title');
                    const optionName = optionTitle ? optionTitle.textContent.trim().replace(/\s*\*$/, '') : 'Unknown Option';
                    selectedOptions[optionName] = checkedInput.value;
                }
            });
            
            log(`Selected options: ${JSON.stringify(selectedOptions)}`);
            
            // Prepare data for API
            const cartData = {
                product_id: productId,
                quantity: parseInt(quantity),
                selected_options: Object.keys(selectedOptions).length > 0 ? selectedOptions : null
            };
            
            log(`Sending cart data: ${JSON.stringify(cartData)}`);
            
            // Send request to API
            fetch('index.php?page=api/cart/add', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(cartData)
            })
            .then(response => {
                log(`Response status: ${response.status}`);
                log(`Response ok: ${response.ok}`);
                return response.text();
            })
            .then(text => {
                log(`Raw response: ${text}`);
                
                document.getElementById('api-results').innerHTML = `
                    <h4>API Response:</h4>
                    <pre>${text}</pre>
                `;
                
                try {
                    const data = JSON.parse(text);
                    log(`Parsed response: ${JSON.stringify(data)}`);
                    if (data.success) {
                        alert(data.message || 'Đã thêm sản phẩm vào giỏ hàng');
                        log('Add to cart successful');
                    } else {
                        alert('Lỗi: ' + (data.message || 'Không thể thêm vào giỏ hàng'));
                        log(`Add to cart failed: ${data.message}`);
                    }
                } catch (e) {
                    log(`JSON parse error: ${e.message}`);
                    log(`Response was: ${text}`);
                    
                    if (text.includes('<html') || text.includes('<!DOCTYPE')) {
                        alert('Lỗi: Server trả về trang HTML thay vì JSON');
                        log('Server returned HTML instead of JSON');
                    } else {
                        alert('Lỗi: Phản hồi từ server không hợp lệ');
                        log('Invalid server response');
                    }
                }
            })
            .catch(error => {
                log(`Fetch error: ${error.message}`);
                alert('Có lỗi xảy ra khi thêm vào giỏ hàng: ' + error.message);
            });
        }
        
        function buyNow() {
            log('Buy now clicked');
            alert('Buy now functionality - would redirect to checkout');
        }
        
        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            log('Page loaded, ready for testing');
            log(`Mock product options: ${JSON.stringify(productOptions)}`);
        });
    </script>
</body>
</html>